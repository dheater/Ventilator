<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RespiraWorks Ventilator: Platformio configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RespiraWorks Ventilator
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Platformio configuration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The [build_config](build_config) directory contains the build configuration.</p>
<p>What follows is the configuration for the deployment scripts.</p>
<h1><a class="anchor" id="autotoc_md336"></a>
Deployment script</h1>
<p>By default, controller software and integration tests will deploy to any one STM32 that is hooked up to your machine.</p>
<p>The <a href="deploy.sh">deploy.sh</a> script provides a convenient way to deploy to multiple connected STM devices, addressing them by user-defined aliases. In order for this to work, you need to modify the Platformio's STLink script, find out the serial number of your Nucleo and add it to the list of aliases.</p>
<p>The script provides its own help on syntax.</p>
<p>The script is also used by integration test tools, so it is a good idea to configure it correctly.</p>
<p>The script is further abstracted by the <a href="../upload.sh">../upload.sh</a> script, which will deploy the default release firmware to the controller with simplified syntax.</p>
<h1><a class="anchor" id="autotoc_md337"></a>
Modifying STLink script</h1>
<p>For the above script to work, a file in your local platformio configuration found here: <code>$HOME/.platformio/packages/tool-openocd/scripts/interface/stlink.cfg</code> must be replaced with the <a href="stlink.cfg"><code>stlink.cfg</code></a> provided here.</p>
<p>This solution is based on a post on the platformio forums <a href="https://community.platformio.org/t/choosing-stlink-v2-programmer/10716">here</a>.</p>
<p>The post is rather old, so the TCL syntax had to be modified to make it work.</p>
<h1><a class="anchor" id="autotoc_md338"></a>
Finding your Nucleo's serial number</h1>
<p>To deploy to a particular STM32 boards connected to your system, first find out the serial numbers of your connected Nucleos.</p>
<p>On Unix machines, running something like <code>udevadm info /dev/ttyACM* | grep SERIAL_SHORT</code> should produce: </p><div class="fragment"><div class="line">E: ID_SERIAL_SHORT=0668FF303435554157105440</div>
<div class="line">E: ID_SERIAL_SHORT=066FFF303435554157105014</div>
<div class="line">E: ID_SERIAL_SHORT=066BFF303435554157104916</div>
</div><!-- fragment --><p>On Windows, you can use the STLink utility provided by ST Micro. The serial number shows up in the log when you connect. Possibly you might need to use this to update the firmware too. Close the utility after you have what you need.</p>
<p>With the STLink script modified, you can now deploy firmware like this: </p><div class="fragment"><div class="line">SERIAL=066BFF303435554157104916 TEST=TEST_IDLE pio run -e integration-test -t upload</div>
</div><!-- fragment --><p>However, this can get tedious, so we recommend...</p>
<h1><a class="anchor" id="autotoc_md339"></a>
Making an alias</h1>
<p>The <a href="device_lookup_table.txt">device_lookup_table.txt</a> file contains a list of aliases.</p>
<p>The list will look something like this: </p><div class="fragment"><div class="line">ALIAS  NUCLEO_SERIAL                COMMENT</div>
<div class="line">p1     0668FF303435554157122853     Pizza #1 at Edwin&#39;s Workshop</div>
<div class="line">p3     0668FF303435554157105440     Pizza #3 at Martin&#39;s farm</div>
</div><!-- fragment --><p>For the first column, make a unique label, hopefully similar to whatever designation has been agreed to by the team. The second column is the serial number obtained by the magic above, and lastly you can have some nice description.</p>
<p><b>PLEASE COMMIT CHANGES</b> after adding your Nucleo to the list. This will help keep things consistently documented as we test software on various prototypes. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
