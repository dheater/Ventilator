<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RespiraWorks Ventilator: Software Design</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RespiraWorks Ventilator
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Software Design </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The RespiraWorks ventilator includes software running on two computers: an STM32 microcontroller and a Raspberry Pi.</p>
<p><img src="module_diagram.png" alt="Module diagram" class="inline"/></p>
<p>The microcontroller runs bare-metal and controls the sensors and actuators (valves and blower). Its main loop runs every 10ms on a hardware timer interrupt, and the code running in the main loop contains no loops of variable length, ensuring minimal jitter. The microcontroller’s software is written in C++.</p>
<p>The Raspberry Pi runs Linux and is used for displaying the GUI. The software we wrote is a Qt app, also written in C++. The app displays a GUI on the ventilator’s touch screen, showing sensor data received from the controller. Users set high-level parameters via the GUI (e.g. "PIP
20 cmH2O"), and then the GUI software commands the controller to meet these parameters. The GUI software is also responsible for calculating alarms and readings derived from raw sensor values (such as measured PIP/PEEP).</p>
<p>We chose to use two separate computers for three reasons.</p><ol type="1">
<li>Two computers reduces the amount of software that is immediately hazardous to the patient. Since our UI code runs on a separate device with no direct access to the ventilator’s actuators, a bug or crash in it is less likely to cause immediate harm; the ventilator will just keep running with the most recent parameters (and, in the future, sound an alarm).</li>
<li>This design saves time and money because it allows us to use large libraries like Linux and Qt, which make it easier to develop the GUI, but would likely be unacceptable in a patient-critical module like the cycle controller.</li>
<li>Having two modules adds a level of redundancy. If the microcontroller crashes, it will immediately receive new commands from the Raspberry Pi, and the Pi can raise an alarm. Similarly, if the Pi crashes, the ventilator continues running with the last set of parameters, and the cycle controller can raise an alarm. (Disclosure: Neither of these alarms is currently implemented, and we have not performed extensive testing of this failure model.)</li>
</ol>
<p>Like the rest of the RespiraWorks project, our software is developed in the open on GitHub. We have an extensive continuous integration infrastructure running unit tests on x86, and we are building infrastructure to run automated tests on the full device. We are also nearly ready to start testing our software against a Modelica simulation of the device. We hope this will make it easier for developers who do not have access to hardware to contribute to the project. We also believe having a robust simulation environment will allow us to run tests that would otherwise be prohibitively time-consuming, for instance running each commit against many combinations of ventilator parameters plus lung compliances.</p>
<p>Besides a detailed user manual and maintenance plan, the device will also come with a robust self-test mode. This ensures that produced ventilators achieve necessary safety levels before they are used with patients and will allow users to check the health of the device over its lifetime. A cryptographic hash will be released with the approved software, and allow local manufacturers to be confident in the software they are loading to the device.</p>
<h1><a class="anchor" id="autotoc_md406"></a>
Communication Between Pi and Microcontroller</h1>
<p>The microcontroller and Raspberry Pi communicate over a serial bus using a simple, predictable protocol. Every ~50ms, the microcontroller sends its current state to the Raspberry Pi, and every ~50ms, the Raspberry Pi sends its full state to the microcontroller. There are no ACKs, resends, detection of missed packets, etc.</p>
<p>This simplified communication protocol avoids failure modes present in other protocols. For instance, imagine a different, stateful protocol where one command the GUI can send is <code>set PIP to X</code>. Suppose the GUI sends two packets, <code>set PIP to 15</code> and <code>set PIP to 20</code>, and imagine that the first one gets corrupted or lost on the wire. The controller must not accept the <code>PIP 20</code> command until it receives and applies the <code>PIP 15</code> command, otherwise the final PIP will be 15! This requires buffers, resends, and complex logic that, in the limit, looks much like a full implementation of TCP.</p>
<p>Our design sidesteps this whole class of problems. If a message gets missed or corrupted, we can just wait for the next one.</p>
<p>The state is encoded for transport on the wire using protocol buffers (specifically, nanopb) and wrapped in a frame with a checksum for detecting packet corruption. As compared to a fully custom binary format, this makes it far easier to change the protocol and potentially interoperate with other systems.</p>
<h1><a class="anchor" id="autotoc_md407"></a>
Software component architecture</h1>
<p><a class="el" href="md__home_runner_work_Ventilator_Ventilator_software_design_controller_architecture.html">Controller architecture</a></p>
<p><a class="el" href="md__home_runner_work_Ventilator_Ventilator_software_design_GUI_architecture.html">GUI architecture</a></p>
<h1><a class="anchor" id="autotoc_md408"></a>
Other documents</h1>
<p>For an overview of the software modules, see the Ventilator software architecture <a href="https://docs.google.com/document/d/1FPB31V72r_keu1_xjUfYCUXGLxBC5hoyCT1naPNNNTA">document</a>.</p>
<p><b>TODO:</b> Migrate contents of the above document to github.</p>
<p>There is a document defining the <a class="el" href="md__home_runner_work_Ventilator_Ventilator_software_design_ventilation_modes.html">ventilation modes</a> we intend to support.</p>
<h1><a class="anchor" id="autotoc_md409"></a>
Testing considerations</h1>
<p>There is a strategy defined for <a class="el" href="md__home_runner_work_Ventilator_Ventilator_software_design_embedded_software_testing.html">embedded software testing</a>.</p>
<h1><a class="anchor" id="autotoc_md410"></a>
Milestones</h1>
<p>We have completed and successfully demonstrated the <a class="el" href="md__home_runner_work_Ventilator_Ventilator_software_design_milestone_alpha.html">Alpha Milestone</a> and the <a class="el" href="md__home_runner_work_Ventilator_Ventilator_software_design_milestone_v0_2.html">v0.2 milestone</a>.</p>
<h1><a class="anchor" id="autotoc_md411"></a>
Design Reviews</h1>
<p><b>TODO:</b> Links to the design reviews </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
