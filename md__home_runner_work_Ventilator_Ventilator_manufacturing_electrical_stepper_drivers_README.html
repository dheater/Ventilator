<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RespiraWorks Ventilator: Stepper driver configuration</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RespiraWorks Ventilator
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Stepper driver configuration </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>When the PCB was originally designed, the ability to add a stepper driver was essentially a hedge, a backup <em>just in case</em> we wanted to try something that required a stepper motor, so if some of this looks hacky, that's why. Now that the stepper-driven valve concept is moving towards the main design, we need to support it. This is a guide to using stepper motors with the Rev1 PCB.</p>
<h1><a class="anchor" id="autotoc_md85"></a>
Background reading</h1>
<ul>
<li>For background on stepper motors in general, the always-excellent Great Scott provides a good <a href="https://youtu.be/bkqoKWP4Oy4">intro to stepper motors</a></li>
<li>For information on the powerSTEP01, the specific driver for X-NUCLEO-IHM03A1 we are using in Rev 1.0 of the PCB, <a href="https://youtu.be/_Arx5CMr_mk">there is a video here</a>. Keep in mind that while this driver is only selected for R&amp;D. We may move to something different in the final product, as powerSTEP01 is likely to be way overkill for this application, but it does offer a lot of convenient features.</li>
</ul>
<h1><a class="anchor" id="autotoc_md86"></a>
Configuring driver boards</h1>
<p>Your steps will differ slightly depending on which type of driver boards you have.</p>
<p>If you are using the interim board, you will be stacking the driver board(s) on top of that. Else - directly to the STM32 controller board.</p>
<h2><a class="anchor" id="autotoc_md87"></a>
IHM03A1</h2>
<p>Consult the <a href="https://www.st.com/resource/en/user_manual/dm00206777-getting-started-with-the-high-power-stepper-motor-driver-expansion-board-based-on-powerstep01-for-stm32-nucleo-stmicroelectronics.pdf">X-NUCLEO-IHM03A1 user manual</a> for information about how to stack the boards. A brief overview of the process follows, but read the manual first.</p>
<p>You will need to move some resistors. The manual link above will list which ones. You can also see in the pictures below.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Bottom board   </th><th class="markdownTableHeadCenter">Top board    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><img src="images/bottom_board.jpg" alt="bottom board" class="inline"/>   </td><td class="markdownTableBodyCenter"><img src="images/top_board.jpg" alt="top board" class="inline"/>   </td></tr>
</table>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadCenter">Install bottom board   </th><th class="markdownTableHeadCenter">Stack top board    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter">Insert the wires of the "bottom" pigtail into the terminal block and connect with this color pattern. Screw them down to ensure a secure connection.   </td><td class="markdownTableBodyCenter">Stack the boards, making sure that the long pins go into all their intended sockets. They tend to get bent and might need some straightening.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyCenter">Before you tighten the power wires, put the two short power wires into the bottom board's power inputs along with the existing wires and screw then down.   </td><td class="markdownTableBodyCenter">Screw the two power wires into the upper board, as well as the "TOP" pigtail using the same color pattern.    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyCenter"><img src="images/bottom_wired.jpg" alt="screw down wires" class="inline"/>   </td><td class="markdownTableBodyCenter"><img src="images/top_wired.jpg" alt="power stack" class="inline"/>   </td></tr>
</table>
<h2><a class="anchor" id="autotoc_md88"></a>
IHM02A1</h2>
<p>If you are using the X-NUCLEO-IHM02A1, you have to change the board configuration to make it compatible with the PCB setup:</p><ul>
<li>Move the 0 Ohm resistor from SB34 to SB12 to connect PA5 to the clock</li>
<li>Move the 0 Ohm resistor from SB23 to SB8 to connect PB6 to CS</li>
</ul>
<p><img src="images/x-nucleo-ihm02a1.jpeg" alt="X-NUCLEO-IHM02A1" class="inline"/></p>
<p>For X-NUCLEO-IHM02A1, you only have to connect the second stepper motor.</p>
<p>**#TODO: which connector is which, how should they be labeled? @inceptionev**</p>
<h1><a class="anchor" id="autotoc_md89"></a>
Integration notes</h1>
<ul>
<li>Note that pin naming conventions and color codes vary from manufacturer to manufacturer.<ul>
<li>If it does nothing and draws no current, swap one wire from the A pair with one wire from the B pair.</li>
<li>If you send a CW command and it turns CCW, then swap the polarity of either the A or B pair, but not both.</li>
</ul>
</li>
<li>Set the correct chip select for the powerSTEP01 (see <a href="https://docs.google.com/spreadsheets/d/1JOSQKxkQxXJ6MCMDI9PwUQ6kiuGdujR4D6EJN9u2LWg/edit?usp=sharing">Hardware ICD</a> for pin assignments)</li>
<li>Send SPI commands to the powerSTEP01 from the NUCLEO to setup the motor settings. <a href="https://github.com/inceptionev/pcbreathe-bringup">sample code: pcbreathe-bringup</a></li>
<li>Send SPI commands to the powerSTEP01 to command motions. <a href="https://github.com/inceptionev/pcbreathe-bringup">sample code: pcbreathe-bringup</a></li>
</ul>
<h1><a class="anchor" id="autotoc_md90"></a>
In action</h1>
<p><img src="images/two_steppers_moving.gif" alt="dual motors moving" class="inline"/> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
