# This Dockerfile creates an image that has the necessary tools to run unit tests and publish coverage reports

FROM debian:buster

RUN apt-get update && \
    apt-get install build-essential python-pip lcov git curl \
    bear cppcheck clang-tidy -y && \
    pip install -U pip && \
    pip install codecov

WORKDIR /root/Ventilator
COPY . ./

RUN ln -s /usr/bin/clang-6.0 /usr/bin/clang && \
    ln -s /usr/bin/clang++-6.0 /usr/bin/clang++

CMD /bin/bash \
    software/gui/gui.sh --install && \
    software/gui/gui.sh --build -f -j && \
    software/gui/gui.sh --test -f -x && \
    cd software/gui && \
    cppcheck -ithird_party -ibuild . --error-exitcode=1 && \
    cd build && \
    cppcheck --project=compile_commands.json -i../../src/third_party . --error-exitcode=1 && \
    run-clang-tidy-7.py -p . && \
    cd tests && \
    curl https://codecov.io/bash > codecov_uploader.sh && \
    chmod +x codecov_uploader.sh && \
    cat codecov_uploader.sh && \
    ./codecov_uploader.sh -F gui
