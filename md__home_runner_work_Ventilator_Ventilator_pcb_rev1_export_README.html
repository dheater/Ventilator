<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RespiraWorks Ventilator: RespiraWorks Ventilator Mainboard Rev 1.0</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RespiraWorks Ventilator
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">RespiraWorks Ventilator Mainboard Rev 1.0 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This directory contains the PCB design files exported from Altium and instructions for setting up the PCB for operation.</p>
<p>The snapshot for this file is <b>20200424v2-RELEASE-CANDIDATE-2</b>.</p>
<p>Previous versions of this iteration are found in the repository up through <a href="https://github.com/RespiraWorks/Ventilator/commit/2513e5da6fe3e8d02f5f1c38cb00bee6b4fabf3e">commit 2513e5d</a>.</p>
<h1><a class="anchor" id="autotoc_md249"></a>
Contents:</h1>
<p>The complete turn-key manufacturing files for Rev 1.0 are provided here. This package includes PCB artwork files, NC drill data, fabrication and assembly drawings, Bill of Materials, and machine-assembly centroid (pick-and-place) files. Any standard PCB fabrication and assembly vendor will be able to manufacture these boards using the provided files.</p>
<p><a href="20200424v2-RespiraWorks-Ventilator-Rev1.0-RC2-DWG-SCH.PDF">Schematic</a></p>
<p><a href="20200424v2-RespiraWorks-Ventilator-Rev1.0-RC2-3D-STEP.step">3D STEP file</a></p>
<p><a href="20200424v2-RespiraWorks-Ventilator-Rev1.0-RC2-PKG-TURNKEY.zip">Manufacturing Package</a></p>
<p><b>TODO:</b> identify the remaining files.</p>
<h1><a class="anchor" id="autotoc_md250"></a>
Requesting hardware for development</h1>
<p>If you are a RespiraWorks contributor, request dev hardware by making an entry <a href="https://docs.google.com/spreadsheets/d/1rf-cOTlQL_LnzrZq-64n7_R_pFyFMdCAxsPC65YqKUg/edit?usp=sharing">here</a></p>
<h1><a class="anchor" id="autotoc_md251"></a>
Important Rev 1.0 PCB Errata</h1>
<ul>
<li><a href="https://github.com/RespiraWorks/Ventilator/issues/739">#739</a>: DNP resistors populated on board, typing 3.3V to the 5V rail (bad) - if you have SN 01, 02, 03, or 05 - don't continue using the board without executing the fix in this issue ticket. See ticket for rework instructions and photos. All other serial number boards are shipping with this issue fixed.</li>
<li><a href="https://github.com/RespiraWorks/Ventilator/issues/738">#738</a>: Yellow and Green alarm LEDs don't work due to a pin use conflict on the nucleo</li>
<li><a href="https://github.com/RespiraWorks/Ventilator/issues/745">#745</a>: Blower command is 5V but nucleo outputs 3.3V. All boards are currently shipping with a level translator fitted which addresses this problem, however the blower will turn on full blast briefly at reset (<a href="https://github.com/RespiraWorks/Ventilator/issues/740">#740</a> - to be fixed in next rev)</li>
<li><a href="https://github.com/RespiraWorks/Ventilator/issues/736">#736</a> I2C sensor connectors labeled A, C, B, D. Should be A, B, C, D :facepalm: To be clear, what this means is, the I2C multiplexer assignments, as labeled on the board in Rev 1.0 are: MUX0: SENSOR A; MUX1: SENSOR C; MUX2: SENSOR B, MUX3: SENSOR D</li>
<li><a href="https://github.com/RespiraWorks/Ventilator/issues/846">#846</a>: anti-miller caps C33 and C34 filter out PWM signal and prevent proper operation. The Miller effect is only present at startup and doesn't cause a problem with permanently connected loads like the PSOL. Remove C33 and C34.</li>
</ul>
<h1><a class="anchor" id="autotoc_md252"></a>
Rev 1.0 PCB Quick Start Guide</h1>
<ul>
<li>If you have SN 01, 02, 03, or 05, make sure you check the errata above before you proceed or you may damage the Rpi.</li>
<li>If you intend to use the stepper motor-based pinch valves, you will need to solder some wires to power the stepper driver as it takes a power input for the motor that is separate from the logic power it gets from the Nucleo below. We will piggyback off the blower driver power socket. Solder two 20cm wires of 22awg or thicker to the backside of J10, the blower power connector. The square pin pad is negative.</li>
</ul>
<p><img src="readme_photos/stepper_power.jpg" alt="solder power connection" class="inline"/></p><ul>
<li>Verify that you have an STM32-L452RE module (not an STM32-L452RE-P module, they have different pinouts - see #51)</li>
</ul>
<p><img src="readme_photos/IMG_9305.jpg" alt="verify model" class="inline"/></p><ul>
<li>Plug the Nucleo into the PCB, observing the silkscreen (white outline on the board) for correct orientation.</li>
</ul>
<p><img src="readme_photos/IMG_9306.jpg" alt="plug in the nucleo" class="inline"/></p><ul>
<li>Move the JP5 jumper in the upper-middle-center of the Nucleo board to the E5V position. This tells the board to expect external power from the PCB. This will avoid programming problems. If you wish to remove the Nucleo board and work with it on its own without the PCB, move the jumper back to the U5V position to power it from USB.</li>
</ul>
<p><img src="readme_photos/IMG_9289.jpg" alt="plug in the nucleo" class="inline"/></p><ul>
<li>If you have a X-NUCLEO-IHM03A1 or X-NUCLEO-IHM02A1 stepper driver accesory, plug that in on top of the Nucleo. The long gold pins of this module can get bent so make sure they are straight and they all go into their respective sockets successfully. The stepper driver green connectors go in the direction of the white connectors on the mainboard PCB. For setting up multiple stepper boards and/or connecting actual steppers, see <a href="../../manufacturing/electrical/stepper_drivers">this guide</a>.</li>
</ul>
<p><img src="readme_photos/IMG_9307.jpg" alt="plug in the stepper driver" class="inline"/></p><ul>
<li>If you are using an Rpi 3B+ or 4 with this PCB, plug this into the RPI socket. Note that if you have the standoffs fitted, do not overtighen them as this can damage the Pi.</li>
</ul>
<p><img src="readme_photos/IMG_9308.jpg" alt="plug in the Rpi" class="inline"/></p><ul>
<li>If you are using Touchscreen w/ Speakers with your Rpi, connect an HDMI cable (included with Touchscreen package) between the Pi and the Touchscreen. Similarly, connect a USB micro cable (included with Touchscreen package) between the Pi and the TOUCH+5V connector on the Touchscreen.</li>
</ul>
<p><img src="readme_photos/IMG_9309.jpg" alt="plug in the Touchscreen" class="inline"/></p><ul>
<li>If you are connecting a blower, take the 6-pin to 6-pin JST XH cable and connect it between the BLOWER CTRL connector at the top of the PCB with corresponding connector on the blower driver. Likewise, take the 2-pin to 2-pin JST VH cable and connect it between BLOWER POWER connector at the top of the PCB and the corresponding connector on the blower driver.</li>
</ul>
<p><img src="readme_photos/IMG_9311.jpg" alt="plug in the nucleo" class="inline"/></p><ul>
<li>The PCB must be powered in order for the Nucleo to program correctly. A power cable which plugs into the upper left corner of the PCB is provided with the board and allows it to be powered from any 12V, 1.2A or greater power adapter with a 5.5x2.1mm center-positive barrel jack. You will want 5A or more if you are also powering solenoids, blowers, and heaters from the PCB. Plug this in to the power the board. A green POWER light in the upper left of the PCB should come on, and the various status lights of the Rpi and Nucleo will probably also come on.</li>
</ul>
<p><img src="readme_photos/IMG_9312.jpg" alt="plug in the nucleo" class="inline"/></p><ul>
<li>When programming over the Nucleo USB interface, the board emulates an ST-Link programming the MCU over SWD. Use these settings in the toolchain of your choice.</li>
<li>The bringup code was written in the Arduino IDE environment with STM32duino installed and can be found here along with basic instructions for setting up STM32dino and programming the STM32. (disclaimer: this code is not part of the project and is pretty much unsupported, use at your own risk. The listing of hardware pin #defines at the top might be useful): <a href="https://github.com/inceptionev/pcbreathe-bringup">pcbreathe-bringup</a><ul>
<li>for more test code with a state machine for running a ventilator setup in closed-loop control mode, see this repo: <a href="https://github.com/inceptionev/FMLtest">FMLtest</a></li>
</ul>
</li>
<li>The main reference for pin and GPIO assignments on this board are in the <a href="https://docs.google.com/spreadsheets/d/1JOSQKxkQxXJ6MCMDI9PwUQ6kiuGdujR4D6EJN9u2LWg/edit?usp=sharing">Electrical Hardware Requirements and PCB Interface Control Document</a></li>
<li>The large power connectors on the PCB are JST VH type.</li>
<li>The smaller peripheral connectors on the PCB are JST XH type.</li>
<li>The buzzer requires an oscillating signal to make sound, it is designed for peak output at 2.4kHz. Take off the kapton cover at your own hearing risk.</li>
<li>On the MPXV5004DP differential pressure sensors, the upper port is the positive measurement, and the lower port is the negative. The transfer function, assuming a 12-bit ADC, is P[kpa] = ADCcounts/819 - 1</li>
<li>The switched heater and solenoid outputs can support a resistive or inductive load up to 2A. Refer to schematic for pinouts.</li>
<li>The i2c sensor connectors are initially configured for providing 3.3V supply power to the sensors, but can be configured for 5V. Each sensor can have its own voltage; they do not need to be the same. If you need to switch to 5V, see the schematic for the resistors to change. Refer to schematic for pinouts.</li>
<li>The analog pressure sensors have an anti-aliasing filter value of 100Hz.</li>
</ul>
<h1><a class="anchor" id="autotoc_md253"></a>
Stepper driver setup</h1>
<p>When the PCB was originally designed, the ability to add a stepper driver was essentially a hedge, a backup <em>just in case</em> we wanted to try something that required a stepper motor.</p>
<p>To use stepper motors, you must add stepper driver boards as described in <a href="../../manufacturing/electrical/stepper_drivers">this guide</a>. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
