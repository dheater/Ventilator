<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RespiraWorks Ventilator: Ventilator controller software</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">RespiraWorks Ventilator
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Ventilator controller software </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Here resides the code for the ventilator controller.</p>
<p>Please also see the <a class="el" href="md__home_runner_work_Ventilator_Ventilator_software_design_controller_architecture.html">Software design pages</a> for more information on controller architecture.</p>
<h1><a class="anchor" id="autotoc_md341"></a>
Rationale and structure</h1>
<p>The ventilator actuators must be driven by control loops ensuring continuous breathing according to doctor-provided parameters, while also ensuring no harm is done to the patient.</p>
<p><a class="el" href="classController.html">Controller</a> code is separated from the user interface code. This makes the code base smaller, easier to maintain, and lessens the risk of unexpected behavior.</p>
<p>The controller shares the <a href="../common">common communications code</a> with the GUI. The part of the code specific to the controller resides here.</p>
<p><b>Directories:</b></p><ul>
<li>[lib](lib) - most of the substantive controller code, must all be libraries to be unit-testable by platformio</li>
<li>[test](test) - unit tests</li>
<li>[integration_tests](integration_tests) - code for (semi-)automated hardware-in-the-loop testbeds</li>
<li>[platformio](platformio) - build configurations and deployment scripts</li>
<li>[src](src) - just the main loop for controller</li>
<li>[src_test](src_test) - just the main loop for unit tests</li>
</ul>
<p><b>Files:</b></p><ul>
<li><a href="platformio.ini">platfomio.ini</a> - the equivalent of a "make file" which governs how platformio builds targets</li>
<li><a href="controller_coverage.sh">controller_coverage.sh</a> - script for generating unit test code coverage reports</li>
<li><a href="test.sh">test.sh</a> - script for running all unit tests</li>
<li><a href="upload.sh">upload.sh</a> - uploads firmware to ventilator controller</li>
</ul>
<h1><a class="anchor" id="autotoc_md342"></a>
Development toolchain</h1>
<p>The target platform for this code is the STM32 processor (currently, the Nucleo L452RE to be precise).</p>
<p>We use <a href="https://platformio.org/">platformio</a> for building the controller code. Platformio has a CLI and an IDE. You'll need the platformio CLI in order to build from the command-line, even if you also install the IDE.</p>
<p>Instructions for installing:</p><ul>
<li><a href="https://docs.platformio.org/en/latest/core/installation.html#super-quick-mac-linux">CLI</a></li>
<li><a href="https://docs.platformio.org/en/latest/integration/ide/vscode.html#installation">IDE</a></li>
</ul>
<p>Note that an issue prevents platformio CLI 5.0 and 5.0.1 to run our unit tests. If you are using one of these versions, you will need to upgrade to 5.0.2 or newer version using: </p><div class="fragment"><div class="line">$ platformio upgrade</div>
</div><!-- fragment --><p>Here's a <a href="https://www.youtube.com/watch?v=EIkGTwLOD7o">video introduction</a> to platformio.</p>
<p>PlatformIO works on Windows as well. You'll need to install <a href="https://atom.io/">Atom</a>, <a href="https://releases.llvm.org/download.html">Clang+LLVM</a>, and <a href="https://www.python.org/downloads/windows/">Python</a>. (Note: you may be asked to install Python 2.7, but PlatformIO works with Python 3.5+ as well, ostensibly.)</p>
<p>You also need to install the package <code>libtinfo5</code> on Linux. Clang-tidy needs this package to run its checks, but platformio will just say all checks have passed without giving an error if it's missing.</p>
<h1><a class="anchor" id="autotoc_md343"></a>
Building and testing</h1>
<p>After installing platformio, you should be able to build and test as follows.</p>
<div class="fragment"><div class="line">$ ./test.sh</div>
<div class="line"># This will run a few commands, such as &quot;platformio run&quot; and</div>
<div class="line"># &quot;platformio test -e native&quot;.</div>
</div><!-- fragment --><p>This is the same script that runs on our continuous integration server (Travis CI). Run it frequently during development to catch errors/style violations early.</p>
<p>Sometimes PlatformIO can get into a bad state - e.g. if things don't build for you in <code>master</code>, try:</p>
<div class="fragment"><div class="line">$ rm -rf .pio/</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md344"></a>
Running on the controller</h1>
<p>To run this you will need at a Nucleo dev board and/or some version of the PCB. For various builds of the physical system, please refer to the <code>system-design</code> folder in this repository.</p>
<p>Plug in the STM32 to your machine, then ask platformio to list all devices connected. You should see a USB serial port corresponding to your device.</p>
<div class="fragment"><div class="line">$ pio device list</div>
<div class="line">/dev/cu.usbserial-14220</div>
<div class="line">-----------------------</div>
<div class="line">Hardware ID: USB VID:PID=1A86:7523 LOCATION=20-2.2</div>
<div class="line">Description: USB2.0-Serial</div>
</div><!-- fragment --><p>Now you can build and upload to the device. <b>Note:</b> The following command should be run in this directory (same as where <code>platformnio.ini</code> lives).</p>
<div class="fragment"><div class="line">$ pio run -t upload</div>
</div><!-- fragment --><p>A more convenient way to run is to use the <a href="upload.sh">upload.sh</a> script. If you have multiple Nucleos that you want to deploy to, you should consult the [platformio configuration guide](platformio).</p>
<p>If you get the following error, it means platformio was unable to find a connected device.</p>
<div class="fragment"><div class="line"># This means pio couldn&#39;t find a device to upload to.  Check that it&#39;s connected?</div>
<div class="line">Error: Please specify `upload_port` for environment or use global `--upload-port` option.</div>
</div><!-- fragment --><p>You may have to modify your <code>udev</code> rule to enable flashing of the controller as follows:</p>
<div class="fragment"><div class="line">curl -fsSL https://raw.githubusercontent.com/platformio/platformio-core/master/scripts/99-platformio-udev.rules | sudo tee /etc/udev/rules.d/99-platformio-udev.rules</div>
<div class="line">sudo service udev restart</div>
<div class="line">sudo usermod -a -G dialout $USER</div>
<div class="line">sudo usermod -a -G plugdev $USER</div>
</div><!-- fragment --><p> and then either re-login or restart machine.</p>
<p>For more details on this, see the following articles: <a href="https://docs.platformio.org/en/latest/faq.html#platformio-udev-rules">platformio FAQ</a> <a href="https://community.platformio.org/t/stm32-vs-code-mbed-upload-issue-error-libusb-open-failed-with-libusb-error-access-error-open-failed/10650">community forums</a></p>
<p>Alternatively, you can upload the firmware.elf and firmware.bin files to the controller mounted as a USB storage device.</p>
<h1><a class="anchor" id="autotoc_md345"></a>
Testing with hardware</h1>
<p>Some (semi-)automated integration tests are in the [integration_tests](integration_tests) directory.</p>
<p>Debug interface and manual testing utilities are in the <a href="../utils">../utils</a> directory. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
